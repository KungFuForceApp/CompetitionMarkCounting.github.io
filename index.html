<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competition Scoring System</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 30px 0; }
        header h1 { font-size: 3rem; background: linear-gradient(90deg, #e94560, #ff6b6b, #feca57); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px; }
        header p { color: #a0a0a0; font-size: 1.1rem; }
        .nav-buttons { display: flex; justify-content: center; gap: 15px; margin: 30px 0; flex-wrap: wrap; }
        .nav-btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .nav-btn.primary { background: linear-gradient(135deg, #e94560, #ff6b6b); color: white; }
        .nav-btn.secondary { background: linear-gradient(135deg, #0f3460, #16213e); color: white; border: 2px solid #e94560; }
        .nav-btn.success { background: linear-gradient(135deg, #00b894, #00cec9); color: white; }
        .nav-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3); }
        .panel { display: none; background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 30px; margin: 20px 0; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .panel.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .panel h2 { color: #e94560; margin-bottom: 25px; font-size: 1.8rem; display: flex; align-items: center; gap: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #ccc; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 10px; background: rgba(255, 255, 255, 0.05); color: #fff; font-size: 1rem; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #e94560; }
        .form-group select option { background: #1a1a2e; color: #fff; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .contestant-list { margin: 20px 0; }
        .contestant-item { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background: rgba(255, 255, 255, 0.03); border-radius: 10px; }
        .contestant-item input[type="text"] { flex: 1; }
        .contestant-item input[type="color"] { width: 50px; height: 40px; border: none; border-radius: 8px; cursor: pointer; }
        .contestant-item button { padding: 10px 15px; background: #e94560; border: none; border-radius: 8px; color: white; cursor: pointer; }
        .add-contestant-btn { padding: 12px 25px; background: linear-gradient(135deg, #00b894, #00cec9); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .mode-info { background: rgba(233, 69, 96, 0.1); border-left: 4px solid #e94560; padding: 15px; border-radius: 0 10px 10px 0; margin: 15px 0; }
        .mode-info h4 { color: #e94560; margin-bottom: 8px; }
        .mode-info p { color: #a0a0a0; font-size: 0.9rem; }
        .submit-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #e94560, #ff6b6b); border: none; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 20px; transition: all 0.3s ease; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(233, 69, 96, 0.4); }
        .competition-id-display { text-align: center; padding: 30px; background: rgba(0, 184, 148, 0.1); border-radius: 15px; margin: 20px 0; }
        .competition-id-display h3 { color: #00b894; margin-bottom: 15px; }
        .competition-id-display .id-code { font-size: 2rem; font-weight: 700; color: #feca57; letter-spacing: 3px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; display: inline-block; }
        .copy-btn { margin-top: 15px; padding: 10px 25px; background: #00b894; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; }
        .referee-panel { text-align: center; }
        .contestant-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }
        .contestant-card { background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px; text-align: center; transition: all 0.3s ease; border: 3px solid transparent; }
        .contestant-card:hover { transform: translateY(-5px); }
        .contestant-card h3 { font-size: 1.5rem; margin-bottom: 15px; }
        .contestant-card .current-score { font-size: 3rem; font-weight: 700; margin: 15px 0; }
        .mark-input { display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 15px; }
        .mark-input input { width: 80px; padding: 10px; text-align: center; font-size: 1.2rem; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; }
        .mark-input button { padding: 10px 20px; background: linear-gradient(135deg, #00b894, #00cec9); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; }
        .quick-marks { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .quick-mark-btn { width: 60px; height: 60px; border: none; border-radius: 50%; font-size: 1.3rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; background: linear-gradient(135deg, #e94560, #ff6b6b); color: white; }
        .quick-mark-btn:hover { transform: scale(1.1); }
        .quick-mark-btn:active { transform: scale(0.95); }
        .quick-mark-btn.voted { background: linear-gradient(135deg, #00b894, #00cec9); animation: pulse 0.5s ease; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .scoreboard { text-align: center; }
        .scoreboard-header { background: linear-gradient(135deg, rgba(233, 69, 96, 0.2), rgba(255, 107, 107, 0.1)); padding: 30px; border-radius: 15px; margin-bottom: 30px; }
        .scoreboard-header h2 { font-size: 2.5rem; margin-bottom: 10px; justify-content: center; }
        .scoreboard-header .description { color: #a0a0a0; margin-bottom: 15px; }
        .competition-timer { font-size: 3rem; font-weight: 700; color: #feca57; font-family: 'Courier New', monospace; margin: 20px 0; }
        .timer-controls { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .timer-controls button { padding: 10px 25px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .timer-controls .start-btn { background: #00b894; color: white; }
        .timer-controls .pause-btn { background: #feca57; color: #1a1a2e; }
        .timer-controls .reset-btn { background: #e94560; color: white; }
        .timer-controls .delete-btn { background: #6c5ce7; color: white; }
        .start-competition-btn { padding: 15px 40px; background: linear-gradient(135deg, #00b894, #00cec9); border: none; border-radius: 10px; color: white; font-size: 1.2rem; font-weight: 700; cursor: pointer; margin: 20px 0; transition: all 0.3s ease; animation: glow 2s ease-in-out infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(0, 184, 148, 0.4); } 50% { box-shadow: 0 0 40px rgba(0, 184, 148, 0.8); } }
        .start-competition-btn:hover { transform: scale(1.05); }
        .start-competition-btn:disabled { background: linear-gradient(135deg, #636e72, #b2bec3); cursor: not-allowed; animation: none; }
        .competition-status { padding: 10px 20px; border-radius: 20px; font-weight: 600; display: inline-block; margin: 10px 0; }
        .competition-status.pending { background: rgba(253, 203, 110, 0.2); color: #feca57; }
        .competition-status.running { background: rgba(0, 184, 148, 0.2); color: #00b894; }
        .competition-status.ended { background: rgba(233, 69, 96, 0.2); color: #e94560; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; animation: fadeIn 0.2s ease; }
        .modal-content { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 30px; max-width: 400px; width: 90%; text-align: center; border: 2px solid #e94560; }
        .modal-content h3 { color: #e94560; margin-bottom: 15px; }
        .modal-content p { color: #a0a0a0; margin-bottom: 25px; }
        .modal-buttons { display: flex; gap: 15px; justify-content: center; }
        .modal-buttons button { padding: 12px 30px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .modal-buttons .confirm-btn { background: #e94560; color: white; }
        .modal-buttons .cancel-btn { background: rgba(255, 255, 255, 0.1); color: white; border: 2px solid rgba(255, 255, 255, 0.2); }
        .scores-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .score-card { background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 25px; text-align: center; border: 3px solid; transition: all 0.3s ease; }
        .score-card .rank { font-size: 0.9rem; color: #a0a0a0; margin-bottom: 5px; }
        .score-card h3 { font-size: 1.5rem; margin-bottom: 10px; }
        .score-card .score { font-size: 3.5rem; font-weight: 700; }
        .score-card.rank-1 { background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.05)); }
        .score-card.rank-2 { background: linear-gradient(135deg, rgba(192, 192, 192, 0.2), rgba(192, 192, 192, 0.05)); }
        .score-card.rank-3 { background: linear-gradient(135deg, rgba(205, 127, 50, 0.2), rgba(205, 127, 50, 0.05)); }
        .vote-indicator { margin-top: 15px; padding: 10px; background: rgba(254, 202, 87, 0.1); border-radius: 8px; }
        .vote-indicator .vote-count { font-size: 0.9rem; color: #feca57; }
        .mark-history { margin-top: 15px; font-size: 0.8rem; color: #a0a0a0; max-height: 100px; overflow-y: auto; }
        .mark-history-item { padding: 5px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .mark-history-item.consensus { color: #00b894; font-weight: 600; }
        .export-panel { margin-top: 30px; padding: 20px; background: rgba(0, 184, 148, 0.1); border-radius: 15px; text-align: center; }
        .export-btn { padding: 15px 40px; background: linear-gradient(135deg, #00b894, #00cec9); border: none; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .export-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 184, 148, 0.4); }
        .status-message { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 10px; font-weight: 600; z-index: 1000; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .status-message.success { background: #00b894; color: white; }
        .status-message.error { background: #e94560; color: white; }
        .status-message.info { background: #0984e3; color: white; }
        .referee-info { background: rgba(9, 132, 227, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .referee-info span { color: #a0a0a0; }
        .referee-count { background: #0984e3; padding: 5px 15px; border-radius: 20px; font-weight: 600; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            header h1 { font-size: 2rem; }
            .nav-buttons { flex-direction: column; align-items: center; }
            .nav-btn { width: 100%; max-width: 300px; }
            .competition-id-display .id-code { font-size: 1.3rem; word-break: break-all; }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Competition Mark Counting App</h1></h1>
            <p>Real-time Competition Scoring System</p>
            <hr> </hr>
            <p>Kung Fu Force/Ryan Lee@2026</p>
        </header>
        <div class="nav-buttons">
            <button class="nav-btn primary" onclick="showPanel('create')">üèÜ Create Competition</button>
            <button class="nav-btn secondary" onclick="showPanel('join')">üéØ Join as Referee</button>
            <button class="nav-btn success" onclick="showPanel('scoreboard')">üìä View Scoreboard</button>
        </div>
        <div id="create-panel" class="panel">
            <h2>üèÜ Create New Competition</h2>
            <div class="form-group">
                <label>Competition Name</label>
                <input type="text" id="comp-name" placeholder="e.g., Kung Fu Competition 2026">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="comp-description" rows="3" placeholder="Brief description of the competition..."></textarea>
            </div>
            <div class="form-group">
                <label>Scoring Mode</label>
                <select id="comp-mode" onchange="updateModeInfo()">
                    <option value="1">Mode 1: Average Scoring</option>
                    <option value="2">Mode 2: Consensus Scoring</option>
                </select>
            </div>
            <div id="mode-info-1" class="mode-info">
                <h4>üìä Mode 1: Average Scoring</h4>
                <p>Each referee submits their score for each contestant. The final score is calculated as the average of all referee scores.</p>
            </div>
            <div id="mode-info-2" class="mode-info hidden">
                <h4>‚ö° Mode 2: Consensus Scoring</h4>
                <p>Referees press score buttons in real-time. When enough referees press the same score within the time window, the contestant earns that score.</p>
            </div>
            <div id="mode2-settings" class="hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label>Consensus Threshold (%)</label>
                        <input type="number" id="consensus-threshold" value="50" min="10" max="100" placeholder="% of referees needed">
                    </div>
                    <div class="form-group">
                        <label>Time Window (seconds)</label>
                        <input type="number" id="time-window" value="0.5" min="0.1" max="5" step="0.1" placeholder="Time window for consensus">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Competition Duration (minutes)</label>
                        <input type="number" id="comp-duration" value="5" min="1" max="60" placeholder="Total competition time">
                    </div>
                    <div class="form-group">
                        <label>Quick Mark Buttons (comma-separated)</label>
                        <input type="text" id="quick-marks" value="1,2,3,5,10" placeholder="e.g., 1,2,3,5,10">
                    </div>
                </div>
            </div>
            <h3 style="margin: 25px 0 15px; color: #feca57;">üë• Contestants</h3>
            <div id="contestants-list" class="contestant-list"></div>
            <button class="add-contestant-btn" onclick="addContestant()">+ Add Contestant</button>
            <button class="submit-btn" onclick="createCompetition()">Create Competition</button>
            <div id="competition-created" class="competition-id-display hidden">
                <h3>‚úÖ Competition Created!</h3>
                <div class="id-code" id="new-comp-id"></div>
                <p style="margin-top: 15px; color: #a0a0a0;">Share this ID with referees</p>
                <button class="copy-btn" onclick="copyCompetitionId()">üìã Copy ID</button>
            </div>
        </div>
        <div id="join-panel" class="panel">
            <h2>üéØ Join as Referee</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Competition ID</label>
                    <input type="text" id="join-comp-id" placeholder="Enter competition ID">
                </div>
                <div class="form-group">
                    <label>Your Name</label>
                    <input type="text" id="referee-name" placeholder="Enter your name">
                </div>
            </div>
            <button class="submit-btn" onclick="joinCompetition()">Join Competition</button>
            <div id="referee-interface" class="referee-panel hidden">
                <div class="referee-info">
                    <span>Competition: <strong id="ref-comp-name"></strong></span>
                    <span>Mode: <strong id="ref-comp-mode"></strong></span>
                    <span class="referee-count">Referees Online: <span id="ref-count">0</span></span>
                </div>
                <div id="ref-timer" class="competition-timer hidden">00:00</div>
                <div id="ref-status" class="competition-status pending hidden">‚è≥ Waiting for competition to start...</div>
                <div id="referee-cards" class="contestant-cards"></div>
            </div>
        </div>
        <div id="scoreboard-panel" class="panel">
            <h2>üìä Live Scoreboard</h2>
            <div class="form-group" style="max-width: 400px; margin: 0 auto 30px;">
                <label>Competition ID</label>
                <input type="text" id="view-comp-id" placeholder="Enter competition ID">
                <button class="submit-btn" style="margin-top: 10px;" onclick="viewScoreboard()">View Scores</button>
            </div>
            <div id="scoreboard-display" class="scoreboard hidden">
                <div class="scoreboard-header">
                    <h2 id="sb-comp-name">Competition Name</h2>
                    <p class="description" id="sb-comp-desc">Description</p>
                    <p>Mode: <strong id="sb-comp-mode"></strong></p>
                    <div id="sb-timer" class="competition-timer hidden">00:00</div>
                    <div id="sb-timer-controls" class="timer-controls hidden">
                        <button class="start-btn" onclick="toggleTimer()">‚ñ∂ Start</button>
                        <button class="reset-btn" onclick="resetTimer()">‚Ü∫ Reset</button>
                    </div>
                    <div id="sb-start-competition" class="hidden">
                        <div id="sb-competition-status" class="competition-status pending">‚è≥ Waiting to Start</div>
                        <br>
                        <button id="sb-start-btn" class="start-competition-btn" onclick="startCompetition()">üöÄ Start Competition</button>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="timer-controls delete-btn" onclick="confirmDeleteCompetition()" style="padding: 10px 25px; border-radius: 8px;">üóëÔ∏è Delete Competition</button>
                    </div>
                </div>
                <div id="scores-grid" class="scores-grid"></div>
                <div class="export-panel">
                    <h3 style="margin-bottom: 15px; color: #00b894;">üì§ Export Results</h3>
                    <button class="export-btn" onclick="exportToGoogleSheets()">Export to Google Sheets</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB2EAzctjXJXEm-ZfIdqDiXDHaGRSVdTxY",
            authDomain: "markcounting.firebaseapp.com",
            databaseURL: "https://markcounting-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "markcounting",
            storageBucket: "markcounting.firebasestorage.app",
            messagingSenderId: "141500133139",
            appId: "1:141500133139:web:b3687a740c658a206f34e6",
            measurementId: "G-8E4QF5VBTD"
        };
        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbySj5OCJ58r1SYnEpYi_oktCIyL2e5sNkTHoIEhmhdslXS6CVaK4lyd6RLPgGjZJ94LAw/exec";
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        let currentCompetitionId = null;
        let currentRefereeId = null;
        let currentRefereeName = null;
        let competitionData = null;
        let timerInterval = null;
        let remainingTime = 0;
        let isTimerRunning = false;
        let unsubscribers = [];
        function showPanel(panelName) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`${panelName}-panel`).classList.add('active');
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
        }
        function updateModeInfo() {
            const mode = document.getElementById('comp-mode').value;
            document.getElementById('mode-info-1').classList.toggle('hidden', mode !== '1');
            document.getElementById('mode-info-2').classList.toggle('hidden', mode !== '2');
            document.getElementById('mode2-settings').classList.toggle('hidden', mode !== '2');
        }
        let contestantCount = 0;
        const colors = ['#e94560', '#00b894', '#0984e3', '#feca57', '#a55eea', '#fd79a8', '#00cec9', '#fdcb6e'];
        function addContestant() {
            contestantCount++;
            const color = colors[(contestantCount - 1) % colors.length];
            const div = document.createElement('div');
            div.className = 'contestant-item';
            div.id = `contestant-${contestantCount}`;
            div.innerHTML = `<input type="text" placeholder="Contestant ${contestantCount} Name" class="contestant-name"><input type="color" value="${color}" class="contestant-color"><button onclick="removeContestant(${contestantCount})">‚úï</button>`;
            document.getElementById('contestants-list').appendChild(div);
        }
        function removeContestant(id) {
            const element = document.getElementById(`contestant-${id}`);
            if (element) element.remove();
        }
        addContestant();
        addContestant();
        function createCompetition() {
            const name = document.getElementById('comp-name').value.trim();
            const description = document.getElementById('comp-description').value.trim();
            const mode = parseInt(document.getElementById('comp-mode').value);
            if (!name) {
                showStatus('Please enter a competition name', 'error');
                return;
            }
            const contestants = [];
            document.querySelectorAll('.contestant-item').forEach(item => {
                const nameInput = item.querySelector('.contestant-name');
                const colorInput = item.querySelector('.contestant-color');
                if (nameInput.value.trim()) {
                    contestants.push({ name: nameInput.value.trim(), color: colorInput.value, score: 0, markHistory: [] });
                }
            });
            if (contestants.length < 2) {
                showStatus('Please add at least 2 contestants', 'error');
                return;
            }
            const competition = {
                name: name,
                description: description,
                mode: mode,
                contestants: contestants,
                referees: {},
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                status: 'pending'
            };
            if (mode === 2) {
                competition.consensusThreshold = parseInt(document.getElementById('consensus-threshold').value) || 50;
                competition.timeWindow = parseFloat(document.getElementById('time-window').value) || 0.5;
                competition.duration = parseInt(document.getElementById('comp-duration').value) * 60;
                competition.quickMarks = document.getElementById('quick-marks').value.split(',').map(m => parseInt(m.trim())).filter(m => !isNaN(m));
                competition.votes = {};
                competition.timerState = { running: false, remaining: competition.duration, lastUpdate: null };
            }
            const compRef = database.ref('competitions').push();
            const compId = compRef.key.substring(0, 8).toUpperCase();
            database.ref(`competitions/${compId}`).set(competition)
                .then(() => {
                    document.getElementById('new-comp-id').textContent = compId;
                    document.getElementById('competition-created').classList.remove('hidden');
                    showStatus('Competition created successfully!', 'success');
                    currentCompetitionId = compId;
                })
                .catch(err => {
                    showStatus('Error creating competition: ' + err.message, 'error');
                });
        }
        function copyCompetitionId() {
            const id = document.getElementById('new-comp-id').textContent;
            navigator.clipboard.writeText(id).then(() => {
                showStatus('Competition ID copied!', 'success');
            });
        }
        function joinCompetition() {
            const compId = document.getElementById('join-comp-id').value.trim().toUpperCase();
            const refereeName = document.getElementById('referee-name').value.trim();
            if (!compId || !refereeName) {
                showStatus('Please enter competition ID and your name', 'error');
                return;
            }
            currentCompetitionId = compId;
            currentRefereeName = refereeName;
            database.ref(`competitions/${compId}`).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showStatus('Competition not found', 'error');
                        return;
                    }
                    competitionData = snapshot.val();
                    currentRefereeId = database.ref(`competitions/${compId}/referees`).push().key;
                    database.ref(`competitions/${compId}/referees/${currentRefereeId}`).set({ name: refereeName, joinedAt: firebase.database.ServerValue.TIMESTAMP, online: true });
                    database.ref(`competitions/${compId}/referees/${currentRefereeId}/online`).onDisconnect().set(false);
                    setupRefereeInterface();
                })
                .catch(err => {
                    showStatus('Error joining competition: ' + err.message, 'error');
                });
        }
        function setupRefereeInterface() {
            document.getElementById('referee-interface').classList.remove('hidden');
            document.getElementById('ref-comp-name').textContent = competitionData.name;
            document.getElementById('ref-comp-mode').textContent = `Mode ${competitionData.mode}`;
            if (competitionData.mode === 2) {
                document.getElementById('ref-timer').classList.remove('hidden');
                document.getElementById('ref-status').classList.remove('hidden');
            }
            const compRef = database.ref(`competitions/${currentCompetitionId}`);
            const unsub = compRef.on('value', snapshot => {
                competitionData = snapshot.val();
                if (competitionData) {
                    updateRefereeCards();
                    updateRefereeCount();
                    if (competitionData.mode === 2) {
                        updateRefTimer();
                        updateRefereeStatus();
                    }
                }
            });
            unsubscribers.push(() => compRef.off('value', unsub));
        }
        function updateRefereeStatus() {
            const statusEl = document.getElementById('ref-status');
            if (!statusEl || !competitionData) return;
            const status = competitionData.status || 'pending';
            const timerRunning = competitionData.timerState?.running || false;
            const remaining = competitionData.timerState?.remaining || 0;
            statusEl.classList.remove('pending', 'running', 'ended');
            if (status === 'running' || timerRunning) {
                statusEl.classList.add('running');
                statusEl.textContent = 'üü¢ Competition Active - Score Now!';
            } else if (remaining <= 0 && status !== 'pending') {
                statusEl.classList.add('ended');
                statusEl.textContent = 'üî¥ Competition Ended';
            } else {
                statusEl.classList.add('pending');
                statusEl.textContent = '‚è≥ Waiting for competition to start...';
            }
        }
        function updateRefereeCards() {
            const container = document.getElementById('referee-cards');
            container.innerHTML = '';
            competitionData.contestants.forEach((contestant, index) => {
                const card = document.createElement('div');
                card.className = 'contestant-card';
                card.style.borderColor = contestant.color;
                if (competitionData.mode === 1) {
                    card.innerHTML = `<h3 style="color: ${contestant.color}">${contestant.name}</h3><div class="current-score" style="color: ${contestant.color}">${calculateAverageScore(index).toFixed(1)}</div><p style="color: #a0a0a0; font-size: 0.9rem;">Your submitted score: ${getMyScore(index) || 'Not yet'}</p><div class="mark-input"><input type="number" id="score-input-${index}" min="0" max="100" step="0.1" placeholder="Score"><button onclick="submitMode1Score(${index})">Submit</button></div>`;
                } else {
                    const quickMarks = competitionData.quickMarks || [1, 2, 3, 5, 10];
                    card.innerHTML = `<h3 style="color: ${contestant.color}">${contestant.name}</h3><div class="current-score" style="color: ${contestant.color}">${contestant.score || 0}</div><div class="quick-marks" id="quick-marks-${index}">${quickMarks.map(mark => `<button class="quick-mark-btn" onclick="submitMode2Vote(${index}, ${mark})" data-mark="${mark}">+${mark}</button>`).join('')}</div><div class="vote-indicator"><span class="vote-count" id="vote-status-${index}">Waiting for votes...</span></div>`;
                }
                container.appendChild(card);
            });
        }
        function calculateAverageScore(contestantIndex) {
            if (!competitionData.mode1Scores) return 0;
            const scores = competitionData.mode1Scores[contestantIndex];
            if (!scores) return 0;
            const values = Object.values(scores).map(s => s.score);
            if (values.length === 0) return 0;
            return values.reduce((a, b) => a + b, 0) / values.length;
        }
        function getMyScore(contestantIndex) {
            if (!competitionData.mode1Scores) return null;
            const scores = competitionData.mode1Scores[contestantIndex];
            if (!scores || !scores[currentRefereeId]) return null;
            return scores[currentRefereeId].score;
        }
        function updateRefereeCount() {
            const referees = competitionData.referees || {};
            const onlineCount = Object.values(referees).filter(r => r.online).length;
            document.getElementById('ref-count').textContent = onlineCount;
        }
        function updateRefTimer() {
            if (competitionData.timerState) {
                const remaining = competitionData.timerState.remaining;
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                document.getElementById('ref-timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        function submitMode1Score(contestantIndex) {
            const input = document.getElementById(`score-input-${contestantIndex}`);
            const score = parseFloat(input.value);
            if (isNaN(score) || score < 0 || score > 100) {
                showStatus('Please enter a valid score (0-100)', 'error');
                return;
            }
            database.ref(`competitions/${currentCompetitionId}/mode1Scores/${contestantIndex}/${currentRefereeId}`).set({ score: score, refereeName: currentRefereeName, timestamp: firebase.database.ServerValue.TIMESTAMP }).then(() => {
                showStatus('Score submitted!', 'success');
                input.value = '';
            }).catch(err => {
                showStatus('Error submitting score: ' + err.message, 'error');
            });
        }
        function submitMode2Vote(contestantIndex, mark) {
            if (!competitionData.timerState || !competitionData.timerState.running) {
                showStatus('Competition timer not running', 'error');
                return;
            }
            const voteRef = database.ref(`competitions/${currentCompetitionId}/votes/${contestantIndex}`).push();
            voteRef.set({ mark: mark, refereeId: currentRefereeId, refereeName: currentRefereeName, timestamp: firebase.database.ServerValue.TIMESTAMP }).then(() => {
                const btn = document.querySelector(`#quick-marks-${contestantIndex} .quick-mark-btn[data-mark="${mark}"]`);
                if (btn) {
                    btn.classList.add('voted');
                    setTimeout(() => btn.classList.remove('voted'), 500);
                }
                checkConsensus(contestantIndex);
            });
        }
        function checkConsensus(contestantIndex) {
            const votes = competitionData.votes?.[contestantIndex];
            if (!votes) return;
            const now = Date.now();
            const timeWindow = (competitionData.timeWindow || 0.5) * 1000;
            const threshold = competitionData.consensusThreshold || 50;
            const referees = competitionData.referees || {};
            const onlineReferees = Object.values(referees).filter(r => r.online).length;
            const requiredVotes = Math.ceil(onlineReferees * threshold / 100);
            const voteArray = Object.values(votes);
            const recentVotes = voteArray.filter(v => {
                const voteTime = v.timestamp;
                return now - voteTime < timeWindow;
            });
            const markCounts = {};
            recentVotes.forEach(v => {
                markCounts[v.mark] = (markCounts[v.mark] || 0) + 1;
            });
            for (const [mark, count] of Object.entries(markCounts)) {
                if (count >= requiredVotes) {
                    const newScore = (competitionData.contestants[contestantIndex].score || 0) + parseInt(mark);
                    database.ref(`competitions/${currentCompetitionId}/contestants/${contestantIndex}/score`).set(newScore);
                    database.ref(`competitions/${currentCompetitionId}/contestants/${contestantIndex}/markHistory`).push({ mark: parseInt(mark), votes: count, timestamp: firebase.database.ServerValue.TIMESTAMP });
                    database.ref(`competitions/${currentCompetitionId}/votes/${contestantIndex}`).remove();
                    showStatus(`+${mark} scored for ${competitionData.contestants[contestantIndex].name}!`, 'success');
                    break;
                }
            }
            updateVoteStatus(contestantIndex, markCounts, requiredVotes);
        }
        function updateVoteStatus(contestantIndex, markCounts, requiredVotes) {
            const statusEl = document.getElementById(`vote-status-${contestantIndex}`);
            if (!statusEl) return;
            const statusParts = Object.entries(markCounts).map(([mark, count]) => `+${mark}: ${count}/${requiredVotes}`);
            statusEl.textContent = statusParts.length > 0 ? statusParts.join(' | ') : 'Waiting for votes...';
        }
        function viewScoreboard() {
            const compId = document.getElementById('view-comp-id').value.trim().toUpperCase();
            if (!compId) {
                showStatus('Please enter a competition ID', 'error');
                return;
            }
            currentCompetitionId = compId;
            const compRef = database.ref(`competitions/${compId}`);
            const unsub = compRef.on('value', snapshot => {
                if (!snapshot.exists()) {
                    showStatus('Competition not found', 'error');
                    return;
                }
                competitionData = snapshot.val();
                updateScoreboard();
            });
            unsubscribers.push(() => compRef.off('value', unsub));
        }
        function updateScoreboard() {
            document.getElementById('scoreboard-display').classList.remove('hidden');
            document.getElementById('sb-comp-name').textContent = competitionData.name;
            document.getElementById('sb-comp-desc').textContent = competitionData.description || '';
            document.getElementById('sb-comp-mode').textContent = competitionData.mode === 1 ? 'Average Scoring' : 'Consensus Scoring';
            if (competitionData.mode === 2) {
                document.getElementById('sb-timer').classList.remove('hidden');
                document.getElementById('sb-timer-controls').classList.remove('hidden');
                document.getElementById('sb-start-competition').classList.remove('hidden');
                updateScoreboardTimer();
                updateCompetitionStatus();
            }
            const contestants = [...competitionData.contestants].map((c, i) => ({ ...c, originalIndex: i, finalScore: competitionData.mode === 1 ? calculateAverageScore(i) : (c.score || 0) }));
            contestants.sort((a, b) => b.finalScore - a.finalScore);
            const container = document.getElementById('scores-grid');
            container.innerHTML = '';
            contestants.forEach((contestant, rank) => {
                const card = document.createElement('div');
                card.className = `score-card rank-${rank + 1}`;
                card.style.borderColor = contestant.color;
                card.innerHTML = `<div class="rank">#${rank + 1}</div><h3 style="color: ${contestant.color}">${contestant.name}</h3><div class="score" style="color: ${contestant.color}">${contestant.finalScore.toFixed(1)}</div>${competitionData.mode === 2 ? `<div class="mark-history">${(contestant.markHistory ? Object.values(contestant.markHistory) : []).slice(-5).map(h => `<div class="mark-history-item consensus">+${h.mark} (${h.votes} votes)</div>`).join('')}</div>` : `<p style="color: #a0a0a0; font-size: 0.8rem; margin-top: 10px;">${countScoresForContestant(contestant.originalIndex)} referee scores</p>`}`;
                container.appendChild(card);
            });
        }
        function countScoresForContestant(index) {
            if (!competitionData.mode1Scores || !competitionData.mode1Scores[index]) return 0;
            return Object.keys(competitionData.mode1Scores[index]).length;
        }
        function updateScoreboardTimer() {
            if (competitionData.timerState) {
                remainingTime = competitionData.timerState.remaining;
                isTimerRunning = competitionData.timerState.running;
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                document.getElementById('sb-timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                const startBtn = document.querySelector('.timer-controls .start-btn');
                if (startBtn) {
                    startBtn.textContent = isTimerRunning ? '‚è∏ Pause' : '‚ñ∂ Start';
                }
            }
        }
        function toggleTimer() {
            if (!currentCompetitionId) return;
            const newState = !isTimerRunning;
            database.ref(`competitions/${currentCompetitionId}/timerState`).update({ running: newState, lastUpdate: firebase.database.ServerValue.TIMESTAMP });
            if (newState) {
                startTimerSync();
            } else {
                stopTimerSync();
            }
        }
        function startTimerSync() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (remainingTime > 0 && isTimerRunning) {
                    remainingTime--;
                    database.ref(`competitions/${currentCompetitionId}/timerState/remaining`).set(remainingTime);
                    if (remainingTime <= 0) {
                        stopTimerSync();
                        database.ref(`competitions/${currentCompetitionId}/timerState/running`).set(false);
                        showStatus('Competition time ended!', 'info');
                    }
                }
            }, 1000);
        }
        function stopTimerSync() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        function resetTimer() {
            if (!currentCompetitionId) return;
            stopTimerSync();
            const duration = competitionData.duration || 300;
            database.ref(`competitions/${currentCompetitionId}/timerState`).set({ running: false, remaining: duration, lastUpdate: firebase.database.ServerValue.TIMESTAMP });
            database.ref(`competitions/${currentCompetitionId}/status`).set('pending');
        }
        function startCompetition() {
            if (!currentCompetitionId || !competitionData) return;
            database.ref(`competitions/${currentCompetitionId}`).update({ status: 'running' }).then(() => {
                database.ref(`competitions/${currentCompetitionId}/timerState`).update({ running: true, lastUpdate: firebase.database.ServerValue.TIMESTAMP });
                startTimerSync();
                showStatus('Competition started!', 'success');
            }).catch(err => {
                showStatus('Error starting competition: ' + err.message, 'error');
            });
        }
        function updateCompetitionStatus() {
            const statusEl = document.getElementById('sb-competition-status');
            const startBtn = document.getElementById('sb-start-btn');
            if (!statusEl || !competitionData) return;
            const status = competitionData.status || 'pending';
            const timerRunning = competitionData.timerState?.running || false;
            const remaining = competitionData.timerState?.remaining || 0;
            statusEl.classList.remove('pending', 'running', 'ended');
            if (status === 'running' || timerRunning) {
                statusEl.classList.add('running');
                statusEl.textContent = 'üü¢ Competition Running';
                startBtn.disabled = true;
                startBtn.textContent = 'üèÉ Competition In Progress';
            } else if (remaining <= 0 && status !== 'pending') {
                statusEl.classList.add('ended');
                statusEl.textContent = 'üî¥ Competition Ended';
                startBtn.disabled = true;
                startBtn.textContent = '‚úì Competition Completed';
            } else {
                statusEl.classList.add('pending');
                statusEl.textContent = '‚è≥ Waiting to Start';
                startBtn.disabled = false;
                startBtn.textContent = 'üöÄ Start Competition';
            }
        }
        function confirmDeleteCompetition() {
            if (!currentCompetitionId) {
                showStatus('No competition selected', 'error');
                return;
            }
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'delete-modal';
            modal.innerHTML = `<div class="modal-content"><h3>‚ö†Ô∏è Delete Competition</h3><p>Are you sure you want to permanently delete this competition?<br><br><strong style="color: #feca57;">${competitionData?.name || currentCompetitionId}</strong><br><br>This action cannot be undone!</p><div class="modal-buttons"><button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button><button class="confirm-btn" onclick="deleteCompetition()">üóëÔ∏è Delete</button></div></div>`;
            document.body.appendChild(modal);
        }
        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            if (modal) modal.remove();
        }
        function deleteCompetition() {
            if (!currentCompetitionId) return;
            const compId = currentCompetitionId;
            database.ref(`competitions/${compId}`).remove()
                .then(() => {
                    closeDeleteModal();
                    showStatus('Competition deleted successfully!', 'success');
                    currentCompetitionId = null;
                    competitionData = null;
                    document.getElementById('scoreboard-display').classList.add('hidden');
                    document.getElementById('view-comp-id').value = '';
                    unsubscribers.forEach(unsub => unsub());
                    unsubscribers = [];
                })
                .catch(err => {
                    closeDeleteModal();
                    showStatus('Error deleting competition: ' + err.message, 'error');
                });
        }
        async function exportToGoogleSheets() {
          if (!competitionData || !currentCompetitionId) {
            showStatus('No competition data to export', 'error');
            return;
          }
        
          const contestants = competitionData.contestants;
          const mode = competitionData.mode;
          let successCount = 0;
          let errorCount = 0;
        
          showStatus('Exporting data...', 'info');
        
          for (let index = 0; index < contestants.length; index++) {
            const contestant = contestants[index];
            const finalScore = mode === 1 ? calculateAverageScore(index) : (contestant.score || 0);
        
            const data = {
              competition_id: currentCompetitionId,
              competition_name: competitionData.name,
              mode: `Mode ${mode}`,
              contestant_name: contestant.name,
              final_score: finalScore.toFixed(2),
              color: contestant.color
            };
        
            if (mode === 1) {
              const scores = competitionData.mode1Scores?.[index];
              data.referee_count = scores ? Object.keys(scores).length : 0;
            } else {
              data.mark_history = (contestant.markHistory ? Object.values(contestant.markHistory) : []).map(h => `+${h.mark}`).join(', ');
            }
        
            const formData = new URLSearchParams();
            for (const [key, value] of Object.entries(data)) {
              formData.append(key, String(value));
            }
        
            try {
              const response = await fetch(GOOGLE_SHEETS_URL, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                body: formData.toString() 
              });
              
              if (response.ok) {
                successCount++;
              } else {
                console.error('Export failed for ' + contestant.name + ':', await response.text());
                errorCount++;
              }
            } catch (error) {
              console.error('Export error for ' + contestant.name + ':', error);
              errorCount++;
            }
          }
        
          if (errorCount === 0) {
            showStatus('Exported ' + successCount + ' contestants to Google Sheets!', 'success');
          } else {
            showStatus('Export: ' + successCount + ' success, ' + errorCount + ' failed. Check console (F12).', 'error');
          }
        }
        function showStatus(message, type) {
            const existing = document.querySelector('.status-message');
            if (existing) existing.remove();
            const div = document.createElement('div');
            div.className = `status-message ${type}`;
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
        window.addEventListener('beforeunload', () => {
            if (currentRefereeId && currentCompetitionId) {
                database.ref(`competitions/${currentCompetitionId}/referees/${currentRefereeId}/online`).set(false);
            }
            stopTimerSync();
        });
    </script>
</body>
</html>
